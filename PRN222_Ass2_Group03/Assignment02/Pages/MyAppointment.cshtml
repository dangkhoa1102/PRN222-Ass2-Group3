@page
@model Assignment02.Pages.MyAppointmentModel
@{
    ViewData["Title"] = "My Test Drive Appointments";
}

@section Styles {
    <link rel="stylesheet" href="~/css/myAppointments.css" asp-append-version="true" />
}

<div class="container">
    <h1>My Test Drive Appointments</h1>

    <!-- Hiển thị thông báo lỗi nếu có -->
    @if (!ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @foreach (var error in ModelState.Values.SelectMany(v => v.Errors))
            {
                <p>@error.ErrorMessage</p>
            }
        </div>
    }

    @if (Model.Appointments.Any())
    {
        <div class="appointments-grid">
            @foreach (var appointment in Model.Appointments)
            {
                <div class="appointment-card @(appointment.Status?.ToLower())">
                    <div class="card-header">
                        <div class="status-badge status-@(appointment.Status?.ToLower())">
                            @appointment.Status
                        </div>
                        <div class="appointment-date">
                            @appointment.AppointmentDate.ToString("dd/MM/yyyy")
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="vehicle-info">
                            <div class="vehicle-image">
                                @if (!string.IsNullOrEmpty(appointment.Vehicle?.Images))
                                {
                                    <img src="@appointment.Vehicle.Images" alt="Vehicle Image" />
                                }
                                else
                                {
                                    <div class="no-image">
                                        <i class="fas fa-car"></i>
                                        <span>No Image</span>
                                    </div>
                                }
                            </div>
                            <div class="vehicle-details">
                                <h3>@appointment.Vehicle?.Name</h3>
                                <p class="dealer-name">
                                    <i class="fas fa-map-marker-alt"></i>
                                    @appointment.Dealer?.Name
                                </p>
                                <p class="appointment-time">
                                    <i class="fas fa-clock"></i>
                                    @appointment.AppointmentDate.ToString("HH:mm")
                                </p>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(appointment.Notes))
                        {
                            <div class="notes">
                                <strong>Notes:</strong> @appointment.Notes
                            </div>
                        }
                    </div>
                    
                    <div class="card-footer">
                        @if (Model.CanCancelAppointment(appointment))
                        {
                            <button type="button" class="btn btn-cancel" onclick="openCancelModal('@appointment.Id', '@appointment.Vehicle?.Name')">
                                <i class="fas fa-times"></i>
                                Cancel Appointment
                            </button>
                        }
                        else if (appointment.Status == "Cancelled")
                        {
                            <span class="cancelled-text">
                                <i class="fas fa-ban"></i>
                                Cancelled
                            </span>
                        }
                        else if (appointment.AppointmentDate <= DateTime.Now.AddHours(24))
                        {
                            <span class="expired-text">
                                <i class="fas fa-exclamation-triangle"></i>
                                Cannot Cancel (Less than 24h)
                            </span>
                        }
                        else
                        {
                            <span class="no-permission-text">
                                <i class="fas fa-lock"></i>
                                No Permission
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-appointments">
            <div class="no-appointments-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h3>No Appointments Found</h3>
            <p>You don't have any test drive appointments yet.</p>
            <a asp-page="/BookTestDrive" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Book New Appointment
            </a>
        </div>
    }

    @if (Model.Appointments.Any())
    {
        <div class="action-buttons">
            <a asp-page="/BookTestDrive" class="btn btn-success">
                <i class="fas fa-plus"></i>
                Book New Appointment
            </a>
        </div>
    }
</div>

<!-- Cancel Appointment Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelModalLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    Cancel Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelForm" method="post">
                <div class="modal-body">
                    <div class="appointment-preview" id="appointmentPreview">
                        <!-- Appointment details will be populated here -->
                    </div>
                    <p class="confirmation-text">Are you sure you want to cancel this appointment?</p>
                    <div class="mb-3">
                        <label for="cancelNote" class="form-label">
                            <i class="fas fa-comment"></i>
                            Reason for cancellation
                        </label>
                        <textarea class="form-control" id="cancelNote" name="CancelNote" rows="4" 
                                  placeholder="Please provide a reason for cancelling this appointment..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i>
                        Close
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check"></i>
                        Confirm Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Debounce function to prevent excessive calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function openCancelModal(appointmentId, vehicleName) {
            // Set the form action
            const form = document.getElementById('cancelForm');
            const preview = document.getElementById('appointmentPreview');
            const note = document.getElementById('cancelNote');
            const modalElement = document.getElementById('cancelModal');
            
            if (form && preview && note && modalElement) {
                form.action = '?handler=Cancel&id=' + appointmentId;
                preview.innerHTML = '<div class="preview-item"><strong>Vehicle:</strong> ' + vehicleName + '</div>';
                note.value = '';
                
                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }

        // Optimize card animations with Intersection Observer
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.appointment-card');
            cards.forEach(card => {
                observer.observe(card);
            });
        });
    </script>
}