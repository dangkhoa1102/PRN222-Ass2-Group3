@page
@model Assignment02.Pages.MyAppointmentModel
@{
    ViewData["Title"] = "My Test Drive Appointments";
}

@section Styles {
    <link rel="stylesheet" href="~/css/myAppointments.css" asp-append-version="true" />
}

<div class="container">
    <h1>My Test Drive Appointments</h1>

    <!-- Hiển thị thông báo lỗi nếu có -->
    @if (!ModelState.IsValid)
    {
        <div class="alert alert-danger">
            @foreach (var error in ModelState.Values.SelectMany(v => v.Errors))
            {
                <p>@error.ErrorMessage</p>
            }
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }

    @if (Model.Appointments.Any())
    {
        <div class="appointments-grid">
            @foreach (var appointment in Model.Appointments)
            {
                <div class="appointment-card @(appointment.Status?.ToLower())">
                    <div class="card-header">
                        <div class="status-badge status-@(appointment.Status?.ToLower())">
                            @(appointment.Status?.ToLower() == "pending" ? "Processing" : appointment.Status)
                        </div>
                        <div class="appointment-date">
                            @appointment.AppointmentDate.ToString("dd/MM/yyyy")
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <div class="vehicle-info">
                            <div class="vehicle-image">
                                @if (!string.IsNullOrEmpty(appointment.Vehicle?.Images))
                                {
                                    <img src="@appointment.Vehicle.Images" alt="Vehicle Image" />
                                }
                                else
                                {
                                    <div class="no-image">
                                        <i class="fas fa-car"></i>
                                        <span>No Image</span>
                                    </div>
                                }
                            </div>
                            <div class="vehicle-details">
                                <h3>@appointment.Vehicle?.Name</h3>
                                <p class="dealer-name">
                                    <i class="fas fa-map-marker-alt"></i>
                                    @appointment.Dealer?.Name
                                </p>
                                <p class="appointment-time">
                                    <i class="fas fa-clock"></i>
                                    @appointment.AppointmentDate.ToString("HH:mm")
                                </p>
                            </div>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(appointment.Notes))
                        {
                            <div class="notes">
                                <strong>Notes:</strong> @appointment.Notes
                            </div>
                        }
                    </div>
                    
                    <div class="card-footer">
                        <a asp-page="/TestDrives/Details" asp-route-id="@appointment.Id" class="btn btn-primary btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none;">
                            <i class="fas fa-eye"></i>
                            View Details
                        </a>
                        @if ((appointment.Status?.ToLower()=="pending" || appointment.Status?.ToLower()=="processing"))
                        {
                            <button type="button" class="btn btn-cancel" onclick="openCancelModal('@appointment.Id', '@appointment.Vehicle?.Name')">
                                <i class="fas fa-times"></i>
                                Cancel Appointment
                            </button>
                        }
                        @if ((appointment.Status?.ToLower()=="completed"))
                        {
                            <form method="post" asp-page-handler="MarkDone" asp-route-id="@appointment.Id" class="d-inline">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check"></i>
                                    Mark as DONE
                                </button>
                            </form>
                        }
                        else if (appointment.Status == "Cancelled")
                        {
                            <span class="cancelled-text">
                                <i class="fas fa-ban"></i>
                                Cancelled
                            </span>
                        }
                        else if (appointment.AppointmentDate <= DateTime.Now.AddHours(24))
                        {
                            <span class="expired-text">
                                <i class="fas fa-exclamation-triangle"></i>
                                Cannot Cancel (Less than 24h)
                            </span>
                        }
                        else
                        {
                            <span class="no-permission-text">
                                <i class="fas fa-lock"></i>
                                No Permission
                            </span>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="no-appointments">
            <div class="no-appointments-icon">
                <i class="fas fa-calendar-times"></i>
            </div>
            <h3>No Appointments Found</h3>
            <p>You don't have any test drive appointments yet.</p>
            <a asp-page="/BookTestDrive" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                Book New Appointment
            </a>
        </div>
    }

    @if (Model.Appointments.Any())
    {
        <div class="action-buttons">
            <a asp-page="/BookTestDrive" class="btn btn-success">
                <i class="fas fa-plus"></i>
                Book New Appointment
            </a>
        </div>
    }
</div>

<!-- Cancel Appointment Modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content shadow-lg border-0" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); border: none;">
                <h5 class="modal-title fw-bold" id="cancelModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Hủy Lịch Hẹn
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="cancelForm" method="post" asp-page-handler="Cancel">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="appointmentId" />
                <div class="modal-body p-4">
                    <div class="text-center mb-3">
                        <i class="fas fa-car text-danger" style="font-size: 2.5rem; opacity: 0.7;"></i>
                    </div>
                    <p class="text-center mb-3 text-muted">
                        Bạn có chắc muốn hủy lịch hẹn <strong id="vehicleNameText" class="text-dark"></strong>?
                    </p>
                    
                    <div class="mb-3">
                        <label for="cancelNote" class="form-label fw-semibold text-dark">
                            <i class="fas fa-edit me-1 text-primary"></i>
                            Lý do hủy lịch
                        </label>
                        <textarea class="form-control border-2" id="cancelNote" name="CancelNote" rows="3" 
                                  placeholder="Vui lòng nhập lý do hủy lịch hẹn..." 
                                  required
                                  style="border-radius: 10px; border-color: #e3f2fd; resize: none; font-size: 14px;"
                                  onfocus="this.style.borderColor='#2196f3'; this.style.boxShadow='0 0 0 0.2rem rgba(33, 150, 243, 0.25)'"
                                  onblur="this.style.borderColor='#e3f2fd'; this.style.boxShadow='none'"></textarea>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Lý do này sẽ được ghi lại trong hệ thống
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 pb-4 px-4">
                    <div class="d-grid gap-2 w-100">
                        <button type="submit" class="btn btn-danger fw-semibold py-2" 
                                style="border-radius: 10px; background: linear-gradient(135deg, #ff6b6b, #ee5a24); border: none;">
                            <i class="fas fa-check me-2"></i>
                            Xác Nhận Hủy
                        </button>
                        <button type="button" class="btn btn-light fw-semibold py-2" 
                                data-bs-dismiss="modal"
                                style="border-radius: 10px; border: 2px solid #e9ecef; color: #6c757d;">
                            <i class="fas fa-times me-2"></i>
                            Đóng
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Debounce function to prevent excessive calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function openCancelModal(appointmentId, vehicleName) {
            // Set the form action
            const form = document.getElementById('cancelForm');
            const preview = document.getElementById('appointmentPreview');
            const note = document.getElementById('cancelNote');
            const modalElement = document.getElementById('cancelModal');
            
            if (form && preview && note && modalElement) {
                form.action = '?handler=Cancel&id=' + appointmentId;
                preview.innerHTML = '<div class="preview-item"><strong>Vehicle:</strong> ' + vehicleName + '</div>';
                note.value = '';
                
                // Show the modal
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }

        // Optimize card animations with Intersection Observer
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                }
            });
        }, observerOptions);

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.appointment-card');
            cards.forEach(card => {
                observer.observe(card);
            });
        });
    </script>
}