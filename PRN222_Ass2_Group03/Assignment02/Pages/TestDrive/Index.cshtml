@page
@model Assignment02.Pages.TestDrive.IndexModel
@{
    ViewData["Title"] = "Quản lý lịch lái thử";
}

<head>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* Thêm các icon SVG tương tự lucide-react */
        .icon {
            display: inline-block;
            vertical-align: middle;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon-user {
            width: 16px;
            height: 16px;
        }

        .icon-car {
            width: 16px;
            height: 16px;
        }

        .icon-phone {
            width: 16px;
            height: 16px;
        }

        .icon-calendar {
            width: 32px;
            height: 32px;
        }

        .icon-search {
            width: 20px;
            height: 20px;
        }

        .icon-check {
            width: 20px;
            height: 20px;
        }

        .icon-x {
            width: 20px;
            height: 20px;
        }

        .icon-eye {
            width: 20px;
            height: 20px;
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-3 rounded-lg">
                        <svg class="icon icon-calendar text-white" viewBox="0 0 24 24">
                            <rect width="18" height="18" x="3" y="4" rx="2" ry="2" />
                            <line x1="16" x2="16" y1="2" y2="6" />
                            <line x1="8" x2="8" y1="2" y2="6" />
                            <line x1="3" x2="21" y1="10" y2="10" />
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Quản Lý Lịch Lái Thử</h1>
                        <p class="text-gray-600">Danh sách lịch lái thử hôm nay</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">Tổng số lịch</p>
                    <p class="text-3xl font-bold text-indigo-600">@Model.TestDrives.Count</p>
                </div>
            </div>

            <form method="get" class="flex gap-4 flex-wrap">
                <div class="flex-1 min-w-64">
                    <div class="relative">
                        <svg class="icon icon-search absolute left-3 top-3 text-gray-400" viewBox="0 0 24 24">
                            <circle cx="11" cy="11" r="8" />
                            <path d="m21 21-4.3-4.3" />
                        </svg>
                        <input type="text"
                               name="searchTerm"
                               placeholder="Tìm kiếm theo tên, SĐT, biển số..."
                               value=""
                               class="w-full pl-10 pr-4 py-2 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none" />
                    </div>
                </div>
            </form>
        </div>

        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-indigo-600 text-white">
                        <tr>
                            <th class="px-4 py-4 text-left font-semibold">Khách hàng</th>
                            <th class="px-4 py-4 text-left font-semibold">Liên hệ</th>
                            <th class="px-4 py-4 text-left font-semibold">Thông tin xe</th>
                            <th class="px-4 py-4 text-left font-semibold">Lịch lái thử</th>
                            <th class="px-4 py-4 text-center font-semibold">Trạng thái</th>
                            <th class="px-4 py-4 text-center font-semibold">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        @if (Model.TestDrives.Any())
                        {
                            @foreach (var testDrive in Model.TestDrives)
                            {
                                <tr class="hover:bg-gray-50 transition @(Model.TestDrives.IndexOf(testDrive) % 2 == 0 ? "bg-white" : "bg-gray-50")">
                                    <td class="px-4 py-4">
                                        <div class="flex items-center gap-2">
                                            <svg class="icon icon-user text-gray-500" viewBox="0 0 24 24"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>
                                            <div>
                                                <p class="font-semibold text-gray-800">@testDrive.Customer.FullName</p>
                                            </div>
                                            <button onclick="showCustomerModal('@testDrive.Id')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Xem chi tiết">
                                                <svg class="icon icon-eye" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4">
                                        <div class="flex items-center gap-2">
                                            <svg class="icon icon-phone text-gray-500" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-7.16-7.05 19.65 19.65 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" /></svg>
                                            <span class="text-gray-700">@testDrive.Customer.Phone</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4">
                                        <div class="flex items-center gap-2">
                                            <svg class="icon icon-car text-gray-500" viewBox="0 0 24 24"><path d="M19 17h2a2 2 0 0 0 2-2v-4a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h2m0 0v-2" /><circle cx="7" cy="17" r="2" /><circle cx="19" cy="17" r="2" /></svg>
                                            <div>
                                                <p class="text-sm text-gray-600">
                                                    <span class="font-semibold text-gray-800">@testDrive.Vehicle.Name</span>
                                                    <button onclick="showVehicleModal('@testDrive.Id')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Xem chi tiết">
                                                        <svg class="icon icon-eye" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                                                    </button>
                                                </p>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4">
                                        <div class="bg-blue-50 px-3 py-2 rounded-lg">
                                            <p class="text-sm font-semibold text-blue-800">@testDrive.AppointmentDate</p>
                                        </div>
                                    </td>
                                    <td class="px-4 py-4 text-center">
                                        @{
                                            string statusColor = testDrive.Status switch
                                            {
                                                "pending" => "bg-yellow-100 text-yellow-800 border-yellow-300",
                                                "confirmed" => "bg-green-100 text-green-800 border-green-300",
                                                "cancelled" => "bg-red-100 text-red-800 border-red-300",
                                                _ => "bg-gray-100 text-gray-800 border-gray-300",
                                            };

                                            string statusText = testDrive.Status switch
                                            {
                                                "pending" => "Chờ xác nhận",
                                                "confirmed" => "Đã xác nhận",
                                                "cancelled" => "Đã hủy",
                                                _ => testDrive.Status,
                                            };
                                        }
                                        <span class="inline-block px-3 py-1 rounded-full text-sm font-semibold border @statusColor">
                                            @statusText
                                        </span>
                                    </td>
                                    <td class="px-4 py-4">
                                        <div class="flex items-center justify-center gap-2">
                                            <button onclick="showAppointmentModal('@testDrive.Id')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Xem chi tiết">
                                                <svg class="icon icon-eye" viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></svg>
                                            </button>
                                            @if (testDrive.Status == "pending")
                                            {
                                                <form method="post" asp-page-handler="Confirm" asp-route-id="@testDrive.Id" class="inline">
                                                    <button type="submit" class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition" title="Xác nhận">
                                                        <svg class="icon icon-check" viewBox="0 0 24 24"><path d="M20 6 9 17l-5-5" /></svg>
                                                    </button>
                                                </form>
                                                <button onclick="showCancelModal('@testDrive.Id')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Hủy">
                                                    <svg class="icon icon-x" viewBox="0 0 24 24"><path d="M18 6 6 18M6 6l12 12" /></svg>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="p-12 text-center">
                                    <svg class="icon icon-calendar w-16 h-16 text-gray-400 mx-auto mb-4" viewBox="0 0 24 24">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                                        <line x1="16" y1="2" x2="16" y2="6" />
                                        <line x1="8" y1="2" x2="8" y2="6" />
                                        <line x1="3" y1="10" x2="21" y2="10" />
                                    </svg>
                                    <h3 class="text-xl font-bold text-gray-800 mb-2">Không tìm thấy lịch nào</h3>
                                    <p class="text-gray-600">Thử thay đổi bộ lọc hoặc từ khóa tìm kiếm</p>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="appointment-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Chi tiết lịch lái thử</h3>
            <div class="mt-2 px-7 py-3">
                <div id="modal-content" class="text-left text-sm text-gray-600">
                    <p class="mb-2"><span class="font-bold">Khách hàng:</span> <span id="appointment-modal-customer-name"></span></p>
                    <p class="mb-2"><span class="font-bold">Số điện thoại:</span> <span id="appointment-modal-customer-phone"></span></p>
                    <p class="mb-2"><span class="font-bold">Email:</span> <span id="appointment-modal-customer-email"></span></p>
                    <hr class="my-3">
                    <p class="mb-2"><span class="font-bold">Xe đăng ký:</span> <span id="appointment-modal-vehicle-name"></span></p>
                    <p class="mb-2"><span class="font-bold">Phiên bản:</span> <span id="appointment-modal-vehicle-version"></span></p>
                    <hr class="my-3">
                    <p class="mb-2"><span class="font-bold">Ngày giờ:</span> <span id="appointment-modal-date"></span></p>
                    <p class="mb-2"><span class="font-bold">Trạng thái:</span> <span id="appointment-modal-status"></span></p>
                    <p class="mb-2"><span class="font-bold">Ghi chú:</span> <span id="appointment-modal-note"></span></p>
                </div>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="hideAllModals()" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">Đóng</button>
            </div>
        </div>
    </div>
</div>


<div id="customer-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Thông tin khách hàng</h3>
            <div class="mt-2 px-7 py-3">
                <p><span class="font-bold">Họ tên:</span> <span id="customer-modal-name"></span></p>
                <p><span class="font-bold">Số điện thoại:</span> <span id="customer-modal-phone"></span></p>
                <p><span class="font-bold">Email:</span> <span id="customer-modal-email"></span></p>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="hideAllModals()" class="px-4 py-2 bg-indigo-600 text-white w-full rounded-lg">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div id="vehicle-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Thông tin xe</h3>
            <div class="mt-2 px-7 py-3 text-left">
                <p><span class="font-bold">Tên xe:</span> <span id="vehicle-modal-name"></span></p>
                <p><span class="font-bold">Hãng:</span> <span id="vehicle-modal-brand"></span></p>
                <p><span class="font-bold">Model:</span> <span id="vehicle-modal-model"></span></p>
                <p><span class="font-bold">Năm sản xuất:</span> <span id="vehicle-modal-year"></span></p>
                <p><span class="font-bold">Giá:</span> <span id="vehicle-modal-price"></span></p>
                <p><span class="font-bold">Mô tả:</span> <span id="vehicle-modal-description"></span></p>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="hideAllModals()" class="px-4 py-2 bg-indigo-600 text-white w-full rounded-lg">Đóng</button>
            </div>
        </div>
    </div>
</div>

<div id="cancel-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Hủy lịch lái thử</h3>
            <p class="mb-4 text-gray-700">Vui lòng nhập lý do hủy:</p>
            <form method="post" asp-page-handler="Cancel" id="cancelForm">
                <input type="hidden" name="id" id="cancelTestDriveId" />
                <textarea id="cancelNote" name="note" rows="4" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"></textarea>
                <div class="mt-4 flex justify-end gap-2">
                    <button type="button" onclick="hideAllModals()" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Đóng</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Xác nhận Hủy</button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        const testDriveData = @Html.Raw(Json.Serialize(Model.TestDrives));

        // Khai báo TẤT CẢ các biến DOM cho từng modal
        const customerModal = document.getElementById('customer-modal');
        const vehicleModal = document.getElementById('vehicle-modal');
        const appointmentModal = document.getElementById('appointment-modal');
        const cancelModal = document.getElementById('cancel-modal'); 

        // Khai báo các biến DOM cho nội dung của POPUP KHÁCH HÀNG
        const customerName = document.getElementById('customer-modal-name');
        const customerPhone = document.getElementById('customer-modal-phone');
        const customerEmail = document.getElementById('customer-modal-email');

        // Khai báo các biến DOM cho nội dung của POPUP XE
        const vehicleName = document.getElementById('vehicle-modal-name');
        const vehicleBrand = document.getElementById('vehicle-modal-brand');
        const vehicleModel = document.getElementById('vehicle-modal-model');
        const vehicleYear = document.getElementById('vehicle-modal-year');
        const vehiclePrice = document.getElementById('vehicle-modal-price');
        const vehicleDescription = document.getElementById('vehicle-modal-description');

        // Khai báo các biến DOM cho nội dung của POPUP LỊCH LÁI THỬ
        const appointmentModalCustomerName = document.getElementById('appointment-modal-customer-name');
        const appointmentModalCustomerPhone = document.getElementById('appointment-modal-customer-phone');
        const appointmentModalCustomerEmail = document.getElementById('appointment-modal-customer-email');
        const appointmentModalVehicleName = document.getElementById('appointment-modal-vehicle-name');
        const appointmentModalVehicleVersion = document.getElementById('appointment-modal-vehicle-version');
        const appointmentDate = document.getElementById('appointment-modal-date');
        const status = document.getElementById('appointment-modal-status');
        const appointmentModalNote = document.getElementById('appointment-modal-note'); 

        // Khai báo các biến DOM cho popup Hủy
        const cancelTestDriveId = document.getElementById('cancelTestDriveId');


        // HÀM ẨN TẤT CẢ CÁC MODAL (CHỈ CÓ MỘT LẦN KHAI BÁO DUY NHẤT)
        function hideAllModals() {
            customerModal.classList.add('hidden');
            vehicleModal.classList.add('hidden');
            appointmentModal.classList.add('hidden');
            cancelModal.classList.add('hidden'); // Đảm bảo ẩn cả modal hủy
        }

        // Hàm hiển thị modal Khách hàng
        function showCustomerModal(id) {
            hideAllModals();
            const data = testDriveData.find(td => td.id === id);

            if (data && data.customer) {
                customerName.textContent = data.customer.fullName;
                customerPhone.textContent = data.customer.phone;
                customerEmail.textContent = data.customer.email || 'Không có';
                customerModal.classList.remove('hidden');
            }
        }

        // Hàm hiển thị modal Xe
        function showVehicleModal(id) {
            hideAllModals();
            const data = testDriveData.find(td => td.id === id);

            if (data && data.vehicle) {
                vehicleName.textContent = data.vehicle.name;
                vehicleBrand.textContent = data.vehicle.brand || 'Không có';
                vehicleModel.textContent = data.vehicle.model || 'Không có';
                vehicleYear.textContent = data.vehicle.year || 'Không có';
                vehiclePrice.textContent = data.vehicle.price ? data.vehicle.price.toLocaleString('vi-VN') + ' VNĐ' : 'Không có';
                vehicleDescription.textContent = data.vehicle.description || 'Không có';

                vehicleModal.classList.remove('hidden');
            }
        }

        // Hàm hiển thị modal Lịch lái thử (Đơn hàng)
        function showAppointmentModal(id) {
            hideAllModals();
            const data = testDriveData.find(td => td.id === id);

            if (data) {
                // Nạp dữ liệu vào popup
                appointmentModalCustomerName.textContent = data.customer.fullName;
                appointmentModalCustomerPhone.textContent = data.customer.phone;
                appointmentModalCustomerEmail.textContent = data.customer.email || 'Không có';
                appointmentModalVehicleName.textContent = data.vehicle.name;
                appointmentModalVehicleVersion.textContent = data.vehicle.version || 'Không có';
                appointmentDate.textContent = data.appointmentDate;
                appointmentModalNote.textContent = data.notes || 'Không có ghi chú';
                let statusText = "";
                switch (data.status) {
                    case "pending":
                        statusText = "Chờ xác nhận";
                        break;
                    case "confirmed":
                        statusText = "Đã xác nhận";
                        break;
                    case "cancelled":
                        statusText = "Đã hủy";
                        break;
                    default:
                        statusText = data.status;
                        break;
                }
                status.textContent = statusText;
                appointmentModal.classList.remove('hidden');
            }
        }

        // HÀM HIỂN THỊ POPUP HỦY
        function showCancelModal(id) {
            hideAllModals();
            cancelTestDriveId.value = id; // Nạp ID vào input ẩn
            cancelModal.classList.remove('hidden');
        }

        // Gắn sự kiện để đóng modal khi click ra bên ngoài
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal-overlay')) {
                hideAllModals();
            }
        });
    </script>
}
